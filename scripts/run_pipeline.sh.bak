#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PY="$ROOT/.venv/bin/python"
LEAN="$(command -v lean)"

# make Lean happy even under cron / Colima
export DOCKER_HOST="unix://$HOME/.colima/default/docker.sock"
export TMPDIR="$HOME/.lean/tmp"
mkdir -p "$TMPDIR"

cd "$ROOT"

echo "â° $(date)  â€”  training model"
"$PY" Research/scripts/train_lightgbm.py

echo "â° $(date)  â€”  back-testing"
"$LEAN" backtest BaselineSMA --output pipeline_last.json

SUMMARY=$(find pipeline_last.json -maxdepth 1 -name '*-summary.json' | head -n 1)
if [[ -f "$SUMMARY" ]]; then
    NEW=$(jq -r '.Statistics["Sharpe Ratio"] // .statistics["Sharpe Ratio"] // ."Sharpe Ratio"' "$SUMMARY")
    OLD=$(cat previous_sharpe.txt 2>/dev/null || echo -999)

    echo "â° $(date)  â€”  Sharpe $NEW (prev $OLD)"

    if (( $(echo "$NEW > $OLD" | bc -l) )); then
        echo "$NEW" > previous_sharpe.txt
        git add Research/models previous_sharpe.txt
        git commit -m "Auto-promote model (Sharpe $NEW)"
        git push origin main
        echo "ğŸš€ promoted improved model"
    fi
else
    echo "âš ï¸  summary JSON not found â€” no promotion"
fi
